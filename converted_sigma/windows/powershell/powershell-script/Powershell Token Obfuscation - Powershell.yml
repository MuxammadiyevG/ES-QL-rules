name: "Powershell Token Obfuscation - Powershell"
description: |
  Detects common token-obfuscation patterns frequently produced by Invoke-Obfuscation and similar techniques
  in PowerShell Script Block Logging. This is intended as a threat-hunting baseline to identify obfuscated
  scripts (backticks inserted into tokens, string-format placeholder reconstruction, and obfuscated ${env:path}).
  Requirements: PowerShell Script Block Logging must be enabled.
  Exclusions: Known benign cases (plain ${env:path}, Chocolatey install scripts, Exchange servicecontrol.ps1 patterns).
  False positives: Possible (heavy legitimate string formatting or intentionally obfuscated admin scripts).
  Triage: Review the full script block for download/execute patterns (IEX, DownloadString, FromBase64String),
  suspicious network/URL usage, and correlate with parent process, user context, and follow-on persistence actions.
type: esql
params: '{}'
schedule_interval: 10m
index:
  - winlogbeat-*
query_language: esql
query: |
  FROM winlogbeat-*
  | EVAL raw = COALESCE(event.original, process.command_line, winlog.event_data.CommandLine, "")
  /* selection: token obfuscation patterns */
  | WHERE (
      /* backtick-in-token pattern like: IN`V`o`Ke-eXp`ResSIOn ... */
      raw RLIKE "(?i)\\w+`(\\w+|\\-|\\.)`[\\w\\s\\+\\|]" OR
      /* string-format reconstruction: "{2}{3}{0}{4}{1}" -f ... (>=2 placeholders) */
      raw RLIKE "\"(\\{\\d\\}){2,}\"\\s*\\-f" OR
      /* obfuscated ${env:path} variant: ${e`Nv:pATh} */
      raw RLIKE "(?i)\\$\\{`?e`?n`?v`?:`?p`?a`?t`?h`?\\}"
    )
  /* filters: exclude known benign cases */
  | WHERE NOT (
      /* filter_envpath: plain env:path usage */
      raw LIKE "*${env:path}*" OR
      /* filter_chocolatey: known Chocolatey script strings */
      raw LIKE "*it will return true or false instead*" OR
      raw LIKE "*The function also prevents `Get-ItemProperty` from failing*" OR
      /* filter_exchange: Exchange servicecontrol.ps1 path + CRLF token usage */
      (file.path RLIKE "(?i)^C:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\.*\\\\bin\\\\servicecontrol\\.ps1$" AND raw LIKE "*`r`n*")
    )
  | EVAL hour_of_day = DATE_EXTRACT("hour", @timestamp)
  | EVAL is_after_hours = CASE(hour_of_day < 7 OR hour_of_day > 20, true, false)
  | STATS
      event_count = COUNT(*),
      users = VALUES(user.name),
      processes = VALUES(process.name),
      executables = VALUES(process.executable),
      cmdlines = VALUES(process.command_line),
      script_paths = VALUES(file.path),
      originals = VALUES(COALESCE(event.original, "")),
      after_hours_hits = SUM(CASE(is_after_hours == true, 1, 0))
    BY host.name, bucket = DATE_TRUNC(20 minutes, @timestamp)
  | WHERE event_count >= 1
  | EVAL risk_score = event_count * 25 + after_hours_hits * 20
  | WHERE risk_score >= 25
  | KEEP bucket, host.name, event_count, users, processes, executables, cmdlines, script_paths, after_hours_hits, risk_score, originals
  | SORT risk_score DESC
enabled: false
tags:
  - attack.defense-evasion
  - attack.t1027.009
  - detection.threat-hunting
severity: medium
risk_score: 55
references:
  - "https://github.com/danielbohannon/Invoke-Obfuscation"
nist: ["AU-6", "SI-4"]
pci_dss: ["10.2"]
mitre_attack:
  TA0005:
    T1027: ["T1027.009"]
