rule_id: 91de9d76-ca74-4758-ae76-a12745b841b3
name: AD Successful Logon After Multiple Failed Attempts (4624/4625)
description: |
  Ushbu qoida credential access va lateral movement texnikalariga bog'liq bo'lib, bir xil manbadan ketma-ket muvaffaqiyatsiz urinishlardan keyin muvaffaqiyatli kirishni aniqlaydi.
  4625 hodisalari ortidan 4624 paydo bo'lishi brute-force yoki credential stuffing muvaffaqiyatga erishganini ko'rsatishi mumkin, bu AD ichida hujumchiga haqiqiy akkaunt bilan harakatlanish imkonini beradi.
  Qonuniy holatlar sifatida foydalanuvchining parolni bir necha marta noto'g'ri kiritishi, saqlangan eski credentiallar yoki servis konfiguratsiyasi xatolari uchrashi mumkin.
  SOC triage bosqichlari:
  - `actor` va `target_user` ni, shuningdek qaysi `hostn` va `src_ip` da hodisa bo'lganini aniqlang.
  - Ushbu kirishlar rejalashtirilgan test, deployment yoki change ticket bilan bog'liqligini tasdiqlang.
  - `src_ip` manbasi, tarmoq segmenti va tarixiy faoliyatini chuqur tekshiring.
  - Ta'sirlangan akkauntlarning guruh a'zoligi, ayniqsa Domain Admins/Enterprise Admins bilan bog'liqligini tekshiring.
  - Shubhali bo'lsa manba IP ni cheklang, akkaunt credentiallarini reset qiling va komprometatsiya doirasini containment qiling.
type: esql
params: '{}'
schedule_interval: 10m
index:
- logs-winlog*
query_language: esql
query: |
  FROM logs-winlog*
  | WHERE @timestamp >= NOW() - 15m
  | WHERE winlog.channel == "Security"
  | WHERE event.code IN ("4624", "4625")
  // Muhim maydonlarni EVAL orqali shakllantiramiz
  | EVAL hostn = winlog.computer_name,
         target_user = COALESCE(winlog.event_data.TargetUserName, winlog.event_data.SamAccountName),
         src_ip = winlog.event_data.IpAddress,
         logon_type = winlog.event_data.LogonType
  // Faqat Domain Controllerlarni filtrlaymiz (Wildcard bilan)
  | WHERE hostn RLIKE "(?i).*(WINDC|ADDC|-DC|DOMAINCONTROLLER).*"
  // Tizim akkauntlarini ($ bilan tugaydigan) chiqarib tashlaymiz
  | WHERE target_user IS NOT NULL AND NOT target_user RLIKE ".*\\$$"
  // Localhost va tushunarsiz IP-larni filtrlaymiz
  | WHERE src_ip IS NOT NULL AND NOT src_ip IN ("-", "::1", "127.0.0.1")
  // Muvaffaqiyatli va xato urinishlarni belgilaymiz
  | EVAL is_success = CASE(event.code == "4624", 1, 0),
         is_failure = CASE(event.code == "4625", 1, 0)
  | STATS 
      total_events = COUNT(*), 
      success_count = SUM(is_success), 
      failure_count = SUM(is_failure), 
      first_seen = MIN(@timestamp), 
      last_seen = MAX(@timestamp), 
      target_users = VALUES(target_user), 
      logon_types = VALUES(logon_type) 
    BY agent_id, src_ip, hostn, bucket = DATE_TRUNC(15m, @timestamp)
  // Hujum mantiqi: Kamida 5 xato va kamida 1 muvaffaqiyatli kirish
  | WHERE failure_count >= 5 AND success_count >= 1
  // Dinamik risk darajasi
  | EVAL dyn_risk = CASE(failure_count >= 25 AND success_count >= 2, 90, failure_count >= 15, 84, 78)
  | KEEP agent_id,bucket, hostn, src_ip, total_events, success_count, failure_count, first_seen, last_seen, target_users, logon_types, dyn_risk
  | SORT dyn_risk DESC, failure_count DESC
  | LIMIT 200
enabled: false
tags:
  - AD
  - Authentication
  - Credential Access
severity: high
risk_score: 78
references:
  - "https://attack.mitre.org/techniques/T1110/"
mitre_attack:
  TA0006:
    T1110: []
nist: ["AU-2", "AU-12", "AC-7", "IA-2"]
pci_dss: ["10.2.4", "10.2.5", "8.1.6"]
gdpr: ["32.1.a", "32.2"]
